<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Network Rewards Tracker (Shareable)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            touch-action: manipulation;
        }
        .scrollable-list {
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .scrollable-list::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .reward-tier-item {
            transition: all 0.3s ease-in-out;
        }
        .reward-tier-complete {
            background-color: #d1fae5;
            text-decoration: line-through;
            opacity: 0.6;
        }
        .difficulty-low { background-color: #dcfce7; color: #15803d; }
        .difficulty-medium { background-color: #fef9c3; color: #a16207; }
        .difficulty-high { background-color: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="loading" class="text-center py-12 text-lg text-gray-500">
        Loading Tracker... (Connecting to Firebase)
    </div>

    <div id="app" class="hidden max-w-4xl mx-auto">
        <!-- Header and Summary -->
        <header class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Reward Network Tracker
            </h1>
            <p class="text-sm text-gray-500 mb-4">
                User ID: <span id="user-id" class="font-mono text-xs bg-gray-100 px-2 py-0.5 rounded"></span>
                <span class="ml-2 font-bold text-indigo-600"> (Public/Shareable Data)</span>
            </p>
            <div id="summary" class="grid grid-cols-3 gap-3 text-center">
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <div class="text-xl font-bold text-indigo-600" id="total-potential">$0.00</div>
                    <div class="text-xs text-indigo-500 mt-1">Total Potential</div>
                </div>
                <div class="p-3 bg-green-50 rounded-lg">
                    <div class="text-xl font-bold text-green-600" id="total-earned">$0.00</div>
                    <div class="text-xs text-green-500 mt-1">Total Earned</div>
                </div>
                <div class="p-3 bg-yellow-50 rounded-lg">
                    <div class="text-xl font-bold text-yellow-600" id="total-remaining">$0.00</div>
                    <div class="text-xs text-yellow-500 mt-1">Remaining Goal</div>
                </div>
            </div>
        </header>

        <!-- Main Tracking List -->
        <main class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700 mb-2 sm:mb-0">Tracking Items</h2>
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <label for="sort-select" class="text-sm text-gray-600 whitespace-nowrap">Sort By:</label>
                    <select id="sort-select" class="rounded-md border-gray-300 shadow-sm p-2 text-sm bg-white w-full" onchange="window.handleSortChange(this)">
                        <option value="network_asc">Hub App (A-Z)</option>
                        <option value="item_asc">Item Name (A-Z)</option>
                        <option value="potential_desc">Payout (High to Low)</option>
                        <option value="difficulty_asc">Difficulty (Low to High)</option>
                    </select>
                </div>
            </div>

            <div id="tracker-list" class="space-y-6 scrollable-list">
                <!-- Tracker items will be injected here -->
            </div>
            <div id="empty-state" class="text-center py-10 text-gray-500 hidden">
                <p>No tracking items added yet!</p>
                <p class="text-sm mt-2">Click the blue plus button to start tracking your rewards.</p>
            </div>
        </main>

        <!-- Floating Add Button -->
        <button id="open-modal-btn" class="fixed bottom-6 right-6 p-4 bg-indigo-600 text-white rounded-full shadow-xl hover:bg-indigo-700 transition duration-300 z-10" aria-label="Add New Item">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>
    </div>

    <!-- Modal for Adding/Editing Item -->
    <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto max-h-full">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4 text-indigo-600" id="modal-title">Add New Tracking Item</h3>
                <form id="item-form" class="space-y-4">
                    <!-- Item Type Selector -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Item Type</label>
                        <select id="item-type" name="itemType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50" required>
                            <option value="Game">Game / Play-to-Earn App</option>
                            <option value="Passive">Passive / Survey / Shopping App</option>
                        </select>
                    </div>

                    <!-- Network & Item Name -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="network-name" class="block text-sm font-medium text-gray-700">Reward Network (Hub App)</label>
                            <input type="text" id="network-name" name="networkName" placeholder="e.g., Swagbucks, Fetch Rewards" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-700">Game/App Name</label>
                            <input type="text" id="item-name" name="itemName" placeholder="e.g., Sunshine Island, Survey Junkie" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                    </div>

                    <!-- Difficulty/Priority Selector -->
                    <div>
                        <label for="difficulty" class="block text-sm font-medium text-gray-700">Difficulty / Effort Level</label>
                        <select id="difficulty" name="difficulty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50" required>
                            <option value="" disabled selected>Select effort level</option>
                            <option value="Low">Low (Quick Gain / Passive)</option>
                            <option value="Medium">Medium (Balanced)</option>
                            <option value="High">High (Long Term Payout / Hard)</option>
                        </select>
                    </div>

                    <!-- Reward Tiers Section -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-2 mt-4">Reward Tiers (Levels/Points)</h4>
                        <div id="reward-tiers-container" class="space-y-3 p-3 bg-indigo-50 rounded-lg">
                            <!-- Tier inputs will be injected here -->
                        </div>
                        <button type="button" id="add-tier-btn" class="mt-2 w-full text-indigo-600 bg-indigo-100 hover:bg-indigo-200 py-2 rounded-md transition duration-150 text-sm font-medium">
                            + Add Another Reward Tier
                        </button>
                    </div>

                    <!-- Current Progress Note -->
                    <div>
                        <label for="current-progress" class="block text-sm font-medium text-gray-700">Current Progress Note (Optional)</label>
                        <textarea id="current-progress" name="currentProgress" rows="2" placeholder="e.g., Currently Level 4, waiting for payout." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">
                            Save Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, updateDoc, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & INITIALIZATION ---

        // **HARDCODED FIREBASE CONFIGURATION (Your Live Keys)**
        // These keys were copied from your Firebase Project settings and replace the old Canvas variables.
        const firebaseConfig = {
          apiKey: "AIzaSyQG9SYsOHJ9LYVe41moMeDUXs1-y-hV4h7qE",
          authDomain: "reward-tracker-app.firebaseapp.com",
          projectId: "reward-tracker-app",
          storageBucket: "reward-tracker-app.appspot.com",
          messagingSenderId: "207427692607",
          appId: "1:207427692607:web:18029c225265abb970708a",
          measurementId: "G-4JWX9C3S46"
        };

        // These variables are derived from the config for public deployment:
        const appId = firebaseConfig.projectId; 
        const initialAuthToken = null; 

        // Initialize Firebase
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let unsubscribeTracker = null;
        window.trackerItems = [];
        window.handleSortChange = handleSortChange; // Expose sort function to global scope for HTML inline
        window.toggleTierComplete = toggleTierComplete; // Expose toggle function

        // Sorting state (default: by network name ascending)
        let sortKey = 'network';
        let sortDirection = 'asc';
        const difficultyMap = { 'Low': 1, 'Medium': 2, 'High': 3 };

        // --- UTILITY FUNCTIONS ---

        // Function to safely parse and format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        };

        // *************** CRITICAL CHANGE FOR SHARING ***************
        // This function now points to the public collection path, making data viewable and editable by anyone
        const getCollectionRef = () => {
            if (!db) return null;
            // Public path: artifacts/{appId}/public/data/reward_tracker
            return collection(db, `artifacts/${appId}/public/data/reward_tracker`);
        };

        // Function to generate a new reward tier input row
        const generateTierInput = (tier = '', payout = '', isComplete = false) => {
            const id = crypto.randomUUID();
            return `
                <div class="flex space-x-2 tier-row" data-id="${id}" data-complete="${isComplete}">
                    <input type="text" name="tierDescription" value="${tier}" placeholder="e.g., Reach Level 6 / Complete 5 Surveys" class="flex-grow rounded-md border-gray-300 shadow-sm p-2 text-sm" required>
                    <input type="number" name="payoutAmount" value="${payout}" placeholder="USD Value" class="w-24 rounded-md border-gray-300 shadow-sm p-2 text-sm" step="0.01" min="0" required>
                    <button type="button" class="remove-tier-btn p-2 text-red-500 hover:text-red-700 transition duration-150" aria-label="Remove Tier">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
            `;
        };

        // --- SORTING LOGIC ---

        const getPotentialPayout = (item) => {
            return item.rewards.reduce((sum, reward) => sum + (reward.payoutUSD || 0), 0);
        };

        const sortItems = (items) => {
            const sorted = [...items];

            sorted.sort((a, b) => {
                let comparison = 0;
                let valA, valB;

                switch (sortKey) {
                    case 'network':
                        valA = a.network.toLowerCase();
                        valB = b.network.toLowerCase();
                        break;
                    case 'item':
                        valA = a.itemName.toLowerCase();
                        valB = b.itemName.toLowerCase();
                        break;
                    case 'potential':
                        valA = getPotentialPayout(a);
                        valB = getPotentialPayout(b);
                        break;
                    case 'difficulty':
                        valA = difficultyMap[a.difficulty] || 99;
                        valB = difficultyMap[b.difficulty] || 99;
                        break;
                    default:
                        valA = a.network.toLowerCase();
                        valB = b.network.toLowerCase();
                }

                if (valA > valB) comparison = 1;
                else if (valA < valB) comparison = -1;

                // For Payout (Potential), we want Descending by default
                if (sortKey === 'potential' && sortDirection === 'desc') {
                    return comparison * -1;
                }
                
                return sortDirection === 'asc' ? comparison : comparison * -1;
            });

            return sorted;
        };

        window.handleSortChange = (selectElement) => {
            const [key, direction] = selectElement.value.split('_');
            sortKey = key;
            sortDirection = direction;
            renderTrackerList(sortItems(window.trackerItems));
        };
        
        // --- RENDER FUNCTIONS ---

        const renderTrackerList = (items) => {
            const listEl = document.getElementById('tracker-list');
            const emptyStateEl = document.getElementById('empty-state');
            listEl.innerHTML = '';

            if (items.length === 0) {
                emptyStateEl.classList.remove('hidden');
                return;
            }
            emptyStateEl.classList.add('hidden');

            const getDifficultyClass = (difficulty) => {
                return `difficulty-${difficulty.toLowerCase()} px-2 py-0.5 rounded-full text-xs font-semibold`;
            };

            // Use simple iteration over the sorted list for cleaner rendering
            items.forEach(item => {
                const itemTypeIcon = item.type === 'Game' ?
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>` :
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;

                const itemHtml = `
                    <div data-id="${item.id}" class="tracker-item bg-white p-4 rounded-lg shadow-md border-t-4 border-indigo-400 hover:shadow-lg transition duration-300">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex flex-col">
                                <h4 class="text-lg font-bold text-gray-800 flex items-center mb-1">
                                    ${itemTypeIcon}
                                    <span class="ml-2">${item.itemName} (${item.network})</span>
                                </h4>
                                <span class="${getDifficultyClass(item.difficulty)} mb-2">${item.difficulty} Effort</span>
                            </div>

                            <div class="flex space-x-2 flex-shrink-0">
                                <button class="edit-item-btn p-1 text-indigo-500 hover:text-indigo-700 transition" data-id="${item.id}" aria-label="Edit Item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>
                                <button class="delete-item-btn p-1 text-red-500 hover:text-red-700 transition" data-id="${item.id}" aria-label="Delete Item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>

                        <p class="text-xs italic text-gray-500 mb-3">Current Progress: ${item.currentProgress || 'No note added.'}</p>

                        <div class="space-y-2">
                            ${item.rewards.map(reward => `
                                <div class="reward-tier-item flex justify-between items-center p-3 rounded-lg border border-gray-200 cursor-pointer ${reward.isComplete ? 'reward-tier-complete' : 'bg-gray-50 hover:bg-indigo-50'}"
                                    data-item-id="${item.id}"
                                    data-tier-id="${reward.id}"
                                    onclick="window.toggleTierComplete('${item.id}', '${reward.id}')">
                                    <span class="text-sm font-medium text-gray-700 truncate">${reward.tier}</span>
                                    <span class="text-sm font-bold ${reward.isComplete ? 'text-gray-500' : 'text-green-600'}">${formatCurrency(reward.payoutUSD)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                 listEl.insertAdjacentHTML('beforeend', itemHtml);
            });

            addEventListeners();
        };

        const renderSummary = (items) => {
            let totalPotential = 0;
            let totalEarned = 0;

            items.forEach(item => {
                item.rewards.forEach(reward => {
                    totalPotential += reward.payoutUSD;
                    if (reward.isComplete) {
                        totalEarned += reward.payoutUSD;
                    }
                });
            });

            const totalRemaining = totalPotential - totalEarned;

            document.getElementById('total-potential').textContent = formatCurrency(totalPotential);
            document.getElementById('total-earned').textContent = formatCurrency(totalEarned);
            document.getElementById('total-remaining').textContent = formatCurrency(totalRemaining);
        };

        // --- FIREBASE LISTENERS & CRUD ---

        const startTrackerListener = () => {
            if (unsubscribeTracker) {
                unsubscribeTracker();
            }
            if (!db || !userId) {
                console.error("Database or User ID not ready for listener.");
                return;
            }

            const rewardsQuery = query(getCollectionRef());

            unsubscribeTracker = onSnapshot(rewardsQuery, (querySnapshot) => {
                window.trackerItems = [];
                querySnapshot.forEach((doc) => {
                    window.trackerItems.push({ id: doc.id, ...doc.data() });
                });
                
                const sortedItems = sortItems(window.trackerItems);
                renderTrackerList(sortedItems);
                renderSummary(window.trackerItems);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');

            }, (error) => {
                console.error("Error listening to rewards: ", error);
            });
        };
        
        const saveItem = async (data, itemId = null) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) return;

            try {
                const itemData = {
                    ...data,
                    userId: userId, // Attach the user ID
                    timestamp: serverTimestamp(),
                };

                if (itemId) {
                    await setDoc(doc(collectionRef, itemId), itemData, { merge: true });
                    // Optional: Update the timestamp on edit
                    await updateDoc(doc(collectionRef, itemId), { timestamp: serverTimestamp() });
                } else {
                    await setDoc(doc(collectionRef), itemData); // Firestore auto-generates ID here
                }
            } catch (error) {
                console.error("Error saving item: ", error);
            }
        };

        const deleteItem = async (itemId) => {
            const collectionRef = getCollectionRef();
            if (!collectionRef) return;
            try {
                await deleteDoc(doc(collectionRef, itemId));
            } catch (error) {
                console.error("Error deleting item: ", error);
            }
        };
        
        window.toggleTierComplete = async (itemId, tierId) => {
            const item = window.trackerItems.find(i => i.id === itemId);
            if (!item) return;

            // Find the reward tier index
            const tierIndex = item.rewards.findIndex(r => r.id === tierId);
            if (tierIndex === -1) return;

            // Toggle the isComplete status
            const newRewards = [...item.rewards];
            newRewards[tierIndex].isComplete = !newRewards[tierIndex].isComplete;

            // Update the document in Firestore
            const itemDocRef = doc(getCollectionRef(), itemId);
            try {
                await updateDoc(itemDocRef, { rewards: newRewards });
            } catch (error) {
                console.error("Error toggling tier complete status:", error);
            }
        };

        // --- INITIALIZATION & AUTHENTICATION ---

        const initializeAppAndAuth = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // Set Firestore logging to see debug messages in the console
                setLogLevel('debug');

                document.getElementById('user-id').textContent = 'Authenticating...';

                // Sign in anonymously since this is a public/sharable app
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id').textContent = userId;
                        startTrackerListener();
                    } else {
                        console.log("No user signed in.");
                        document.getElementById('user-id').textContent = 'Failed to Authenticate';
                        document.getElementById('loading').textContent = 'Authentication Failed. Check console.';
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                document.getElementById('loading').textContent = 'Connection Error. See console for details.';
            }
        };

        window.onload = initializeAppAndAuth;

        // --- EVENT HANDLERS (MODAL & FORM LOGIC) ---
        
        let editingItemId = null; // State to track if we are editing or adding

        const modal = document.getElementById('item-modal');
        const form = document.getElementById('item-form');
        const container = document.getElementById('reward-tiers-container');
        const modalTitle = document.getElementById('modal-title');
        
        document.getElementById('open-modal-btn').addEventListener('click', () => {
            editingItemId = null;
            modalTitle.textContent = 'Add New Tracking Item';
            form.reset();
            container.innerHTML = generateTierInput(); // Start with one empty tier
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        });

        document.getElementById('close-modal-btn').addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        // Close modal when clicking outside (on the overlay)
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });

        // Add tier button handler
        document.getElementById('add-tier-btn').addEventListener('click', () => {
            container.insertAdjacentHTML('beforeend', generateTierInput());
        });

        // Remove tier button handler (uses event delegation since buttons are dynamically added)
        container.addEventListener('click', (e) => {
            if (e.target.closest('.remove-tier-btn')) {
                e.target.closest('.tier-row').remove();
            }
        });

        // Form Submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const rewards = [];
            const tierRows = container.querySelectorAll('.tier-row');
            
            tierRows.forEach(row => {
                const tier = row.querySelector('[name="tierDescription"]').value.trim();
                const payout = parseFloat(row.querySelector('[name="payoutAmount"]').value);
                
                if (tier && !isNaN(payout)) {
                    rewards.push({
                        id: row.dataset.id || crypto.randomUUID(),
                        tier: tier,
                        payoutUSD: payout,
                        isComplete: row.dataset.complete === 'true'
                    });
                }
            });

            if (rewards.length === 0) {
                // Use a visual indicator instead of alert()
                console.error("Please add at least one valid reward tier.");
                return; 
            }

            const data = {
                type: document.getElementById('item-type').value,
                network: document.getElementById('network-name').value.trim(),
                itemName: document.getElementById('item-name').value.trim(),
                difficulty: document.getElementById('difficulty').value,
                currentProgress: document.getElementById('current-progress').value.trim(),
                rewards: rewards
            };

            await saveItem(data, editingItemId);
            
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            form.reset();
        });

        // Event listener setup for dynamic buttons (Edit and Delete)
        const addEventListeners = () => {
            // Remove old listeners to prevent duplicates
            document.querySelectorAll('.edit-item-btn').forEach(btn => btn.removeEventListener('click', handleEditClick));
            document.querySelectorAll('.delete-item-btn').forEach(btn => btn.removeEventListener('click', handleDeleteClick));

            // Add new listeners
            document.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.addEventListener('click', handleEditClick);
            });

            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteClick);
            });
        };

        const handleEditClick = (e) => {
            e.stopPropagation();
            const itemId = e.currentTarget.dataset.id;
            const item = window.trackerItems.find(i => i.id === itemId);

            if (!item) return;

            editingItemId = itemId;
            modalTitle.textContent = 'Edit Tracking Item';

            // Populate form fields
            document.getElementById('item-type').value = item.type;
            document.getElementById('network-name').value = item.network;
            document.getElementById('item-name').value = item.itemName;
            document.getElementById('difficulty').value = item.difficulty;
            document.getElementById('current-progress').value = item.currentProgress;

            // Populate reward tiers
            container.innerHTML = '';
            item.rewards.forEach(reward => {
                container.insertAdjacentHTML('beforeend', generateTierInput(
                    reward.tier, 
                    reward.payoutUSD.toString(), 
                    reward.isComplete
                ));
            });
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const handleDeleteClick = (e) => {
            e.stopPropagation();
            const itemId = e.currentTarget.dataset.id;
            // Simple visual indicator for delete confirmation (no alert)
            if (window.confirm('Are you sure you want to delete this item?')) {
                 deleteItem(itemId);
            }
        };

    </script>
</body>
</html>
